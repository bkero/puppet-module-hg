# vim: syntax=apache

# PUPPET MANAGED! Do not edit!
# $Id$
#
WSGISocketPrefix /var/run/wsgi
<VirtualHost *:80>
    ServerName <%= @vhost %>
    DocumentRoot <%= @wsgi_path %>

    RewriteEngine on
    RewriteRule ^/(.*)index.cgi/?(.*) http://<%= @vhost %>/$1$2

    SetEnv HGENCODING UTF-8
    SetEnv LC_TYPE UTF-8

    WSGIDaemonProcess <%= @vhost %> processes=24 threads=1 maximum-requests=100 deadlock-timeout=60 inactivity-timeout=300 user=hg group=hg display-name=<%= @vhost %>
    WSGIProcessGroup <%= @vhost %>

    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/json

    # For https://bugzilla.mozilla.org/show_bug.cgi?id=670781
    ScriptAlias /repo-group /usr/local/bin/repo-group

    WSGIScriptAliasMatch ^/(users/[^/]+)(.*) <%= @wsgi_path %>/$1/hgweb.wsgi$2
    WSGIScriptAliasMatch ^/(releases/l10n-mozilla-1.9..)(.*) <%= @wsgi_path %>/$1/hgweb.wsgi$2
    WSGIScriptAliasMatch ^/(releases/l10n-mozilla-2.0)(.*) <%= @wsgi_path %>/$1/hgweb.wsgi$2
    WSGIScriptAliasMatch ^/(releases/l10n-miramar)(.*) <%= @wsgi_path %>/$1/hgweb.wsgi$2
    WSGIScriptAliasMatch ^/(releases/l10n/mozilla-aurora)(.*) <%= @wsgi_path %>/$1/hgweb.wsgi$2
    WSGIScriptAliasMatch ^/(releases/l10n/mozilla-beta)(.*) <%= @wsgi_path %>/$1/hgweb.wsgi$2
    WSGIScriptAliasMatch ^/(releases/l10n/mozilla-release)(.*) <%= @wsgi_path %>/$1/hgweb.wsgi$2
    WSGIScriptAliasMatch ^/(incubator|testpilot-l10n|weave-l10n|gaia-l10n|build|labs|services|l10n(?!-)|l10n-central|projects|automation|qa|hgcustom|webtools|releases|rewriting-and-analysis|www)(.*) <%= @wsgi_path %>/$1/hgweb.wsgi$2
    WSGIScriptAliasMatch ^/dist(.*) <%= @wsgi_path %>/dist/hgweb.wsgi$1
    WSGIScriptAliasMatch ^/integration(.*) <%= @wsgi_path %>/integration/hgweb.wsgi$1
    WSGIScriptAliasMatch ^(/(?!users|robots).*) <%= @wsgi_path %>/hgweb.wsgi$1

    <Location /users>
	Options +Indexes
	Order allow,deny
	Allow from all
    </Location>
    #LogLevel debug
    LogFormat "%h %v %u %t \"%r\" %>s %b %D \"%{Referer}i\" \"%{User-Agent}i\" \"%{Cookie}i\""
    ErrorLog "/var/log/httpd/<%= @vhost %>/error_log"
    CustomLog "/var/log/httpd/<%= @vhost %>/access_log" combined env=!image
</VirtualHost>

# Local variables:
# mode: apache
# tab-width: 4
# indent-tabs-mode: nil
# end:
